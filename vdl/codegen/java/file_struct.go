package java

import (
	"bytes"
	"log"

	"veyron2/vdl"
	"veyron2/vdl/compile"
	"veyron2/vdl/vdlutil"
)

const structTmpl = `// This file was auto-generated by the veyron vdl tool.
// Source: {{.Source}}
package {{.PackagePath}};

/**
 * type {{.Name}} {{.VdlTypeString}} {{.Doc}}
 **/
public final class {{.Name}} {
    {{/* Field declarations */}}
    {{ range $field := .Fields }}
      private {{$field.Type}} {{$field.LowercaseName}};
    {{ end }}

    {{/* Constructor */}}
    public {{.Name}}({{ .FieldsAsArgs }}) {
        {{ range $field := .Fields }}
            this.{{$field.LowercaseName}} = {{$field.LowercaseName}};
        {{ end }}
    }

    {{/* Getters and setters */}}
    {{ range $field := .Fields }}
    public {{$field.Type}} get{{$field.Name}}() {
        return this.{{$field.LowercaseName}};
    }
    public void set{{$field.Name}}({{$field.Type}} {{$field.LowercaseName}}) {
        this.{{$field.LowercaseName}} = {{$field.LowercaseName}};
    }
    {{ end }}

    @Override
    public boolean equals(java.lang.Object obj) {
        if (this == obj) return true;
        if (obj == null) return false;
        if (this.getClass() != obj.getClass()) return false;
        final {{.Name}} other = ({{.Name}})obj;

        {{ range $field := .Fields }}
        {{ if .IsClass }}
        if (this.{{$field.LowercaseName}} == null) {
            if (other.{{$field.LowercaseName}} != null) {
                return false;
            }
        } else if (!this.{{$field.LowercaseName}}.equals(other.{{$field.LowercaseName}})) {
            return false;
        }
        {{ else }}
        if (this.{{$field.LowercaseName}} != other.{{$field.LowercaseName}}) {
            return false;
        }
        {{ end }} {{/* if is class */}}
        {{ end }} {{/* range over fields */}}
        return true;
    }
    @Override
    public int hashCode() {
        int result = 1;
        final int prime = 31;
        {{ range $field := .Fields }}
        result = prime * result + {{$field.HashcodeComputation}};
        {{ end }}
        return result;
    }
}`

type structDefinitionField struct {
	HashcodeComputation string
	IsClass             bool
	LowercaseName       string
	Name                string
	Type                string
}

func javaFieldArgStr(structType *vdl.Type, env *compile.Env) string {
	var buf bytes.Buffer
	for i := 0; i < structType.NumField(); i++ {
		if i > 0 {
			buf.WriteString(", ")
		}
		fld := structType.Field(i)
		buf.WriteString("final ")
		buf.WriteString(javaType(fld.Type, false, env))
		buf.WriteString(" ")
		buf.WriteString(vdlutil.ToCamelCase(fld.Name))
	}
	return buf.String()
}

// genJavaStructFile generates the Java class file for the provided user-defined type.
func genJavaStructFile(tdef *compile.TypeDef, env *compile.Env) JavaFileInfo {
	fields := make([]structDefinitionField, tdef.Type.NumField())
	for i := 0; i < tdef.Type.NumField(); i++ {
		fld := tdef.Type.Field(i)
		fields[i] = structDefinitionField{
			HashcodeComputation: javaHashCode(vdlutil.ToCamelCase(fld.Name), fld.Type, env),
			IsClass:             isClass(fld.Type, env),
			LowercaseName:       vdlutil.ToCamelCase(fld.Name),
			Name:                fld.Name,
			Type:                javaType(fld.Type, false, env),
		}
	}

	data := struct {
		Doc           string
		Fields        []structDefinitionField
		FieldsAsArgs  string
		Name          string
		PackagePath   string
		Source        string
		VdlTypeString string
	}{
		Doc:           javaDocInComment(tdef.Doc),
		Fields:        fields,
		FieldsAsArgs:  javaFieldArgStr(tdef.Type, env),
		Name:          tdef.Name,
		PackagePath:   javaPath(javaGenPkgPath(tdef.File.Package.Path)),
		Source:        tdef.File.BaseName,
		VdlTypeString: tdef.BaseType.String(),
	}
	var buf bytes.Buffer
	err := parseTmpl("struct", structTmpl).Execute(&buf, data)
	if err != nil {
		log.Fatalf("vdl: couldn't execute struct template: %v", err)
	}
	return JavaFileInfo{
		Name: tdef.Name + ".java",
		Data: buf.Bytes(),
	}
}
