package java

import (
	"bytes"
	"log"
	"path"

	"veyron.io/veyron/veyron2/vdl/compile"
)

const clientFactoryTmpl = `// This file was auto-generated by the veyron vdl tool.
// Source(s):  {{ .Sources }}
package {{ .PackagePath }};

/* Factory for binding to {{ .ServiceName }}Client interfaces. */
public final class {{ .ServiceName }}ClientFactory {
    public static {{ .ServiceName }}Client bind(final java.lang.String name) throws io.veyron.veyron.veyron2.VeyronException {
        return bind(name, null);
    }
    public static {{ .ServiceName }}Client bind(final java.lang.String name, final io.veyron.veyron.veyron2.Options veyronOpts) throws io.veyron.veyron.veyron2.VeyronException {
        io.veyron.veyron.veyron2.ipc.Client client = null;
        if (veyronOpts != null && veyronOpts.get(io.veyron.veyron.veyron2.OptionDefs.CLIENT) != null) {
            client = veyronOpts.get(io.veyron.veyron.veyron2.OptionDefs.CLIENT, io.veyron.veyron.veyron2.ipc.Client.class);
        } else if (veyronOpts != null && veyronOpts.get(io.veyron.veyron.veyron2.OptionDefs.RUNTIME) != null) {
            client = veyronOpts.get(io.veyron.veyron.veyron2.OptionDefs.RUNTIME, io.veyron.veyron.veyron2.VRuntime.class).getClient();
        } else {
            client = io.veyron.veyron.veyron2.RuntimeFactory.defaultRuntime().getClient();
        }
        return new {{ .StubName }}(client, name);
    }
}
`

// genJavaClientFactoryFile generates the Java file containing client bindings for
// all interfaces in the provided package.
func genJavaClientFactoryFile(iface *compile.Interface, env *compile.Env) JavaFileInfo {
	data := struct {
		Sources     string
		ServiceName string
		PackagePath string
		StubName    string
	}{
		Sources:     iface.File.BaseName,
		ServiceName: iface.Name,
		PackagePath: javaPath(javaGenPkgPath(iface.File.Package.Path)),
		StubName:    javaPath(javaGenPkgPath(path.Join(iface.File.Package.Path, javaGenImplDir, iface.Name+"ClientStub"))),
	}
	var buf bytes.Buffer
	err := parseTmpl("client factory", clientFactoryTmpl).Execute(&buf, data)
	if err != nil {
		log.Fatalf("vdl: couldn't execute client template: %v", err)
	}
	return JavaFileInfo{
		Name: iface.Name + "ClientFactory.java",
		Data: buf.Bytes(),
	}
}
